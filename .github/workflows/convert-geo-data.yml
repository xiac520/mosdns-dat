name: Fetch and Decode Geo Files

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  schedule:
    - cron: '0 0 * * 5'  # 每周五午夜运行
  workflow_dispatch:  # 允许手动触发

jobs:
  fetch-and-decode-geo-files:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Go
      uses: actions/setup-go@v2
      with:
        go-version: 1.19.2

    - name: Install v2dat
      run: |
        go install github.com/urlesistiana/v2dat@latest

    - name: Fetch geosite.dat and geoip.dat
      run: |
        curl -LJO https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geoip.dat
        curl -LJO https://github.com/Loyalsoldier/v2ray-rules-dat/releases/latest/download/geosite.dat

    - name: Create output directory
      run: |
        mkdir -p dat

    - name: Unpack geoip.dat
      run: |
        v2dat unpack geoip -o dat -f "private" geoip.dat
        v2dat unpack geoip -o dat -f "cn" geoip.dat

    - name: Unpack geosite.dat
      run: |
        v2dat unpack geosite -o dat -f "cn" geosite.dat
        v2dat unpack geosite -o dat -f "gfw" geosite.dat
        v2dat unpack geosite -o dat -f "category-ads-all" geosite.dat
        v2dat unpack geosite -o dat -f "geolocation-!cn" geosite.dat

    - name: Move decoded files to root directory
      run: |
        mv dat/* .

    - name: Commit and push changes
      env:
        GH_TOKEN: ${{ secrets.GH_TOKEN }}
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git add .
        git commit -m "Update geo files"
        git push https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }}
